@model DetailVm

@section Styles {
    <style>
         .shop-banner {

            background: linear-gradient(135deg, var(--steam-darker) 0%, var(--steam-dark) 100%);
            padding: 80px 0 60px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .banner-content h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 15px;
        }
                .search-section {
            margin-top: 20px;
        }

        .search-form {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
            display: flex;
            max-width: 500px;
            margin-left: auto;
            border: 1px solid var(--steam-border);
        }

        .search-input {
            background: transparent;
            border: none;
            color: var(--steam-light);
            padding: 12px 15px;
            flex: 1;
            outline: none;
        }

        .search-input::placeholder {
            color: var(--steam-text-secondary);
        }

        .search-button {
            background: var(--steam-highlight);
            border: none;
            color: white;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-button:hover {
            background: var(--steam-blue);
        }
        body {
            background-color: #0b1a2d;
            color: #c6d4df;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .page-heading {
            background-color: #171a21;
            padding: 30px 0;
            border-bottom: 1px solid #2a475e;
        }

            .page-heading h3 {
                color: #66c0f4;
                font-weight: 700;
                font-size: 32px;
                margin-bottom: 5px;
            }

        .btn-danger {
            background-color: #e74c3c;
            border: none;
            color: #fff;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

            .btn-danger:hover {
                background-color: #c0392b;
            }

        .breadcrumb {
            font-size: 14px;
            color: #66c0f4;
        }

            .breadcrumb a {
                color: #66c0f4;
                text-decoration: none;
                transition: color 0.3s;
            }

                .breadcrumb a:hover {
                    color: #a4c8ff;
                    text-decoration: underline;
                }

        .container {
            max-width: 1140px;
        }


        .carousel-item img {
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            object-fit: cover;
            max-height: 400px;
            width: 100%;
        }

        .col-md-5 h2 {
            color: white;
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .col-md-5 p {
            font-size: 16px;
            color: #c6d4df;
            margin-bottom: 10px;
        }

        .col-md-5 strong {
            color: #66c0f4;
        }

        del {
            color: #778899;
            margin-right: 10px;
        }

        .text-danger {
            color: #ff4757 !important;
            font-weight: 700;
        }


        .btn-primary {
            background-color: #66c0f4;
            border: none;
            padding: 12px 25px;
            font-weight: 600;
            border-radius: 6px;
            transition: background-color 0.3s;
            box-shadow: 0 4px 15px rgba(102, 192, 244, 0.6);
        }

            .btn-primary:hover {
                background-color: #4a8edb;
                box-shadow: 0 6px 20px rgba(74, 142, 219, 0.8);
            }


        h5 {
            color: #66c0f4;
            font-weight: 700;
        }

     
        .list-group-item {
            background-color: #1b2838;
            border: none;
            border-bottom: 1px solid #2a475e;
            color: #c6d4df;
        }

            .list-group-item strong {
                color: #66c0f4;
            }

  
        .card {
            background-color: #171a21;
            border: none;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 12px 30px rgba(102, 192, 244, 0.8);
            }

        .card-img-top {
            border-radius: 8px 8px 0 0;
            height: 160px;
            object-fit: cover;
        }

        .card-body {
            padding: 15px;
            color: #c6d4df;
        }

        .card-title {
            color: #66c0f4;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .card p {
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-outline-primary {
            color: #66c0f4;
            border-color: #66c0f4;
            font-weight: 600;
            transition: all 0.3s;
            padding: 6px 12px;
            font-size: 14px;
        }

            .btn-outline-primary:hover {
                background-color: #66c0f4;
                color: #171a21;
                border-color: #66c0f4;
            }

       
        .game-frame iframe {
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
        }

       
        textarea.form-control {
            background-color: #1b2838;
            color: #c6d4df;
            border: 1px solid #2a475e;
            border-radius: 6px;
        }

            textarea.form-control:focus {
                border-color: #66c0f4;
                box-shadow: 0 0 8px #66c0f4;
                background-color: #17212b;
                color: #fff;
            }

        form button.btn-sm {
            background-color: #66c0f4;
            border: none;
            color: #171a21;
            font-weight: 600;
            padding: 5px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

            form button.btn-sm:hover {
                background-color: #4a8edb;
            }


        .disabled-button {
            background-color: #2a475e !important;
            color: #778899 !important;
            cursor: not-allowed !important;
            box-shadow: none !important;
            border: none !important;
        }
    </style>
}

<section class="shop-banner ">
    <div class="container mt-5">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="banner-content">
                    <h1>Game Shop</h1>
                    <p class="breadcrumb">
                       <a href="/">Home</a> > <a href="/shop">Shop</a> > @Model.Game.Name
                    </p>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="search-section">
                    <form asp-controller="Search" asp-action="Index" method="get" class="search-form">
                        <input type="text" name="query" class="search-input" placeholder="Search games..." />
                        <button type="submit" class="search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>


<div class="container mt-5">
    <div class="row">
        <div class="col-md-7">
            <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    @for (int i = 0; i < Model.ImageUrls.Count; i++)
                    {
                        <div class="carousel-item @(i == 0 ? "active" : "")">
                            <img src="@Model.ImageUrls[i]" class="d-block w-100 rounded shadow" alt="Game Image">
                        </div>
                    }

                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <div class="col-md-5">
            <h2>@Model.Game.Name</h2>
            <p>
                <strong>Price:</strong>
                @if (Model.Game.Discount > 0)
                {
                    <del>$@Model.Game.Price</del>
                    <span class="text-danger"> $@((Model.Game.Price - Model.Game.Discount).ToString("0.##"))</span>
                }
                else
                {
                    <span>$@Model.Game.Price</span>
                }
            </p>

            <p>
                <strong>Category:</strong>
                @if (Model.Game.GameCatagories?.Any() == true)
                {
                    @string.Join(", ", Model.Game.GameCatagories.Select(gc => gc.Catagory?.Name))
                }
                else
                {
                    <span>No categories</span>
                }
            </p>

            <p><strong>Dimensionality:</strong> @Model.Game.Dimensionality</p>

            <button class="btn btn-primary mt-3" onclick="AddToBasket(@Model.Game.Id)" data-game-id="@Model.Game.Id">Add to Cart</button>

            <div class="mt-3">
                <h5>Rating</h5>
                <p>Average: @Model.AverageRating.ToString("0.0") / 5</p>
                @if (User.Identity.IsAuthenticated)
                {
                    <form asp-action="AddRating" method="post">
                        <input type="hidden" name="gameId" value="@Model.Game.Id" />
                        <select name="score" class="form-select w-auto d-inline">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <option value="@i" selected="@(Model.UserRating == i ? "selected" : null)">@i</option>
                            }
                        </select>
                        <button class="btn btn-sm btn-success">Submit</button>
                    </form>
                }
                else
                {
                    <p><a href="/Identity/Account/Login">Log in</a> to rate this game.</p>
                }
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <h4>Description</h4>
            <p>@Model.Game.Description</p>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <h4>Comments</h4>
            <ul class="list-group">
                @if (Model.Comments?.Any() == true)
                {
                    @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                    {
                        <li class="list-group-item">
                            <strong>@(comment.User?.UserName ?? "Anonymous")</strong> -
                            <small>@comment.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>

                            @if (User.Identity.IsAuthenticated && comment.UserId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier).Value)
                            {
                                <form asp-action="DeleteComment" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.Id" />
                                    <input type="hidden" name="gameId" value="@Model.Game.Id" />
                                    <button type="submit" class="btn btn-sm btn-danger float-end ms-2" onclick="return confirm('Are you sure you want to delete this comment?')">Delete</button>
                                </form>
                            }

                            <p>@comment.Text</p>
                        </li>

                    }
                }
                else
                {
                    <li class="list-group-item">No comments yet.</li>
                }
            </ul>

            @if (User.Identity.IsAuthenticated)
            {
                <form asp-action="AddComment" method="post" class="mt-3">
                    <input type="hidden" name="GameId" value="@Model.Game.Id" />
                    <textarea name="Text" class="form-control mb-2" rows="3" placeholder="Write a comment..." required></textarea>
                    <button class="btn btn-sm btn-primary">Submit Comment</button>
                </form>
            }
            else
            {
                <p><a href="/Identity/Account/Login">Log in</a> to leave a comment.</p>
            }
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <h4>Related Games</h4>
            <div class="row">
                @foreach (var item in Model.RelatedGames)
                {
                    <div class="col-md-3">
                        <div class="card">
                            <img src="@item.PhotoUrl" class="card-img-top" alt="@item.Name">
                            <div class="card-body">
                                <h6 class="card-title">@item.Name</h6>
                                @if (item.Discount > 0)
                                {
                                    <p><del>$@item.Price</del> <span class="text-danger">$@((item.Price - item.Discount).ToString("0.##"))</span></p>
                                }
                                else
                                {
                                    <p>$@item.Price</p>
                                }
                                <a href="/game/detail/@item.Id" class="btn btn-outline-primary btn-sm">View Game</a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <h4>Gameplay</h4>
            <div class="game-frame">
                <iframe src="@Model.Game.GameUrl" width="100%" height="600" style="border: none; border-radius: 10px;" allowfullscreen></iframe>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let ownedGameIds = [];

        fetch('/Cart/GetOwnedGameIds')
            .then(response => response.json())
            .then(data => {
                ownedGameIds = data.ids;
                disableOwnedGamesButtons();
            });

        function disableOwnedGamesButtons() {
            ownedGameIds.forEach(id => {
                const btn = document.querySelector(`button[data-game-id="${id}"]`);
                if (btn) {
                    btn.disabled = true;
                    btn.innerText = "In Library";
                    btn.classList.add('disabled-button');
                }
            });
        }

        function AddToBasket(id) {
            if (ownedGameIds.includes(id)) {
                Swal.fire({
                    icon: 'info',
                    title: 'Info',
                    text: 'You already own this game in your library.'
                });
                return;
            }

            $.ajax({
                url: `/Cart/AddToBasket?id=${id}`,
                type: "GET",
                success: function (res) {
                    if (res.success) {
                        Swal.fire({
                            title: "Game added to cart!",
                            icon: "success"
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: res.message || 'Failed to add to cart!'
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'AJAX error',
                        text: 'Something went wrong!'
                    });
                }
            });
        }
    </script>
}
